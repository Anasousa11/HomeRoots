{% extends 'core/base.html' %}

{% block content %}

<div class="container my-5">
    <h2>Student Progress Overview</h2>

{% for item in students_data %}
<div class="mt-5">

    <h3>{{ item.student.first_name }} {{ item.student.last_name }}</h3>

    {% if item.completed %}
    <h4 class="mt-3">Completed Lessons</h4>

    <table class="table table-striped mt-2">
        <thead>
            <tr>
                <th>Lesson</th>
                <th>Subject</th>
                <th>Level</th>
                <th>Grade</th>
                <th>Completed At</th>
            </tr>
        </thead>
        <tbody>
            {% for record in item.completed %}
            <tr>
                <td>{{ record.lesson.title }}</td>
                <td>{{ record.lesson.get_subject_display }}</td>
                <td>{{ record.lesson.get_level_display }}</td>
                <td>{{ record.grade|default:"N/A" }}</td>
                <td>{{ record.completed_at|date:"d M Y" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Chart Container -->
    <h5 class="mt-4">Grade Distribution</h5>
    <canvas id="chart-{{ item.student.id }}" width="400" height="300"></canvas>

    {% else %}
    <p>No completed lessons yet.</p>
    {% endif %}

    <hr>
</div>
{% endfor %}


</div>

<!-- Chart.js -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
{% for item in students_data %}
    const ctx{{ item.student.id }} = document.getElementById('chart-{{ item.student.id }}').getContext('2d');

    const data{{ item.student.id }} = {
        labels: {{ item.labels|safe }},
        datasets: [{
            label: 'Number of Lessons',
            data: {{ item.data|safe }},
            backgroundColor: [
                'rgba(75, 192, 192, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(255, 99, 132, 0.6)'
            ]
        }]
    };

    new Chart(ctx{{ item.student.id }}, {
        type: 'pie',
        data: data{{ item.student.id }},
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                title: {
                    display: true,
                    text: '{{ item.student.first_name }} {{ item.student.last_name }} - Grade Distribution'
                }
            }
        }
    });
{% endfor %}
</script>

{% endblock %}
